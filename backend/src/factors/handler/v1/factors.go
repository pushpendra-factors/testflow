package v1

import (
	"encoding/json"
	mid "factors/middleware"
	M "factors/model"
	U "factors/util"
	"net/http"

	"github.com/gin-gonic/gin"
)

// Factors Constants
var CAMPAIGNTYPE string = "campaign"
var ATTRIBUTETYPE string = "attribute"
var JOURNEYTYPE string = "journey"

// Factors object
type Factors struct {
	GoalRule              M.FactorsGoalRule `json:"goal"`
	Insights              []FactorsInsights `json:"insights"`
	GoalUserCount         float64           `json:"goal_user_count"`
	TotalUsersCount       float64           `json:"total_users_count"`
	OverallPercentageText string            `json:"overall_percentage_text"`
	OverallPercentage     float64           `json:"overall_percentage"`
	OverallMultiplier     float64           `json:"overall_multiplier"`
}

// FactorsAttributeTuple object
type FactorsAttributeTuple struct {
	FactorsAttributeKey   string `json:"factors_attribute_key"`
	FactorsAttributeValue string `json:"factors_attribute_value"`
}

// FactorsInsights object
type FactorsInsights struct {
	FactorsInsightsAttribute      []FactorsAttributeTuple `json:"factors_insights_attribute"`
	FactorsInsightsKey            string                  `json:"factors_insights_key"`
	FactorsInsightsText           string                  `json:"factors_insights_text"`
	FactorsHigherCompletionText   string                  `json:"factors_higher_completion_text"`
	FactorsLowerCompletionText    string                  `json:"factors_lower_completion_text"`
	FactorsInsightsMultiplier     float64                 `json:"factors_insights_multiplier"`
	FactorsInsightsPercentage     float64                 `json:"factors_insights_percentage"`
	FactorsInsightsUsersCount     float64                 `json:"factors_insights_users_count"`
	FactorsGoalUsersCount         float64                 `json:"factors_goal_users_count"`
	FactorsMultiplierIncreaseFlag bool                    `json:"factors_multiplier_increase_flag"`
	FactorsInsightsType           string                  `json:"factors_insights_type"`
	FactorsSubInsights            []*FactorsInsights      `json:"factors_sub_insights"`
}

// GetAllFactorsHandler - Factors handler
func PostFactorsHandler(c *gin.Context) {
	factorsOutput := "{\"goal\":{\"st_en\":\"All Visitors\",\"en_en\":\"Demo Scheduled\",\"rule\":{\"st_en_ft\":null,\"en_en_ft\":null,\"st_us_ft\":null,\"en_us_ft\":null,\"ft\":null},\"vs\":true,\"st_time\":\"2020-10-01T00:00:00Z\",\"en_time\":\"2020-10-31T00:00:00Z\"},\"insights\":[{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Competitors\",\"factors_insights_text\":\"of which visitors from the campaign Acme - Competitors shows 2x higher goal completion\",\"factors_insights_multiplier\":2,\"factors_insights_percentage\":4.24,\"factors_insights_users_count\":2948,\"factors_goal_users_count\":125,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Brand\",\"factors_insights_text\":\"of which visitors from the campaign Acme - Brand shows 1.4x higher goal completion\",\"factors_insights_multiplier\":1.4,\"factors_insights_percentage\":2.9,\"factors_insights_users_count\":11421,\"factors_goal_users_count\":339,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - High Intent\",\"factors_insights_text\":\"of which visitors from the campaign Acme - High Intent shows 1.8x higher goal completion\",\"factors_insights_multiplier\":1.8,\"factors_insights_percentage\":3.8,\"factors_insights_users_count\":14858,\"factors_goal_users_count\":567,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Retargeting\",\"factors_insights_text\":\"of which visitors from the campaign Acme - Retargeting shows 1.6x higher goal completion\",\"factors_insights_multiplier\":1.6,\"factors_insights_percentage\":3.3,\"factors_insights_users_count\":6603,\"factors_goal_users_count\":224,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Lost Prospects\",\"factors_insights_text\":\"of which visitors from the campaign Acme - Lost Prospects shows 0.2x lower goal completion\",\"factors_insights_multiplier\":0.2,\"factors_insights_percentage\":1.3,\"factors_insights_users_count\":6132,\"factors_goal_users_count\":78,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Features\",\"factors_insights_text\":\"of which visitors from the campaign Acme - Features shows 1.1x higher goal completion\",\"factors_higher_completion_text\": \"Higher Completion for Acme - Competitors +3 factors\",\"factors_insights_multiplier\":1.1,\"factors_insights_percentage\":2.3,\"factors_insights_users_count\":19939,\"factors_goal_users_count\":465,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":[{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Retargeting\",\"factors_insights_text\":\"and then Acme - Retargeting shows 1.3x higher goal completion\",\"factors_insights_multiplier\":1.3,\"factors_insights_percentage\":3,\"factors_insights_users_count\":1866,\"factors_goal_users_count\":56,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - High Intent\",\"factors_insights_text\":\"and then Acme - High Intent shows 2.1x higher goal completion\",\"factors_insights_multiplier\":2.1,\"factors_insights_percentage\":4.8,\"factors_insights_users_count\":1333,\"factors_goal_users_count\":64,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Brand\",\"factors_insights_text\":\"and then Acme - Brand shows 2.4x higher goal completion\",\"factors_insights_multiplier\":2.4,\"factors_insights_percentage\":5.5,\"factors_insights_users_count\":963,\"factors_goal_users_count\":53,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Competitors\",\"factors_insights_text\":\"and then Acme - Competitors shows 4x higher goal completion\",\"factors_higher_completion_text\": \"Higher Completions for Acme - Retargeting +1 factor\",\"factors_lower_completion_text\": \"Lower Completions for Acme - Lost Prospects\",\"factors_insights_multiplier\":4,\"factors_insights_percentage\":9.2,\"factors_insights_users_count\":836,\"factors_goal_users_count\":77,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":[{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Retargeting\",\"factors_insights_text\":\"and then Acme - Retargeting shows 5.1x higher goal completion\",\"factors_insights_multiplier\":5.1,\"factors_insights_percentage\":112,\"factors_insights_users_count\":6132,\"factors_goal_users_count\":23,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - High Intent\",\"factors_insights_text\":\"and then Acme - High Intent shows 4.7x higher goal completion\",\"factors_insights_multiplier\":4.7,\"factors_insights_percentage\":9.2,\"factors_insights_users_count\":95,\"factors_goal_users_count\":18,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"Acme - Lost Prospects\",\"factors_insights_text\":\"and then Acme - Lost Prospects shows 0.4x lower goal completion\",\"factors_insights_multiplier\":0.4,\"factors_insights_percentage\":9.2,\"factors_insights_users_count\":187,\"factors_goal_users_count\":3,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"campaign\",\"factors_sub_insights\":null}]}]},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Industry\",\"factors_attribute_value\":\"Diversified Financial Services\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Industry = Diversified Financial Services shows 0.8x lower goal completion\",\"factors_insights_multiplier\":0.8,\"factors_insights_percentage\":1.7,\"factors_insights_users_count\":14529,\"factors_goal_users_count\":247,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Industry\",\"factors_attribute_value\":\"Education Services\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Industry = Education Services shows 2.4x higher goal completion\",\"factors_higher_completion_text\": \"Higher Completions for Designation = Director +2 factors\",\"factors_lower_completion_text\": \"Lower Completions for Company_Revenue = 50mn+\",\"factors_insights_multiplier\":2.4,\"factors_insights_percentage\":5,\"factors_insights_users_count\":9560,\"factors_goal_users_count\":478,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":[{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Designation\",\"factors_attribute_value\":\"Director\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Designation = Director shows 3.1x higher goal completion\",\"factors_insights_multiplier\":3.1,\"factors_insights_percentage\":7.44,\"factors_insights_users_count\":1693,\"factors_goal_users_count\":126,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Revenue\",\"factors_attribute_value\":\"50mn+\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Revenue = 50mn+ shows 0.4x lower goal completion\",\"factors_insights_multiplier\":0.4,\"factors_insights_percentage\":0.96,\"factors_insights_users_count\":1458,\"factors_goal_users_count\":14,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Num_contacts_in_company\",\"factors_attribute_value\":\"<=3\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Num_contacts_in_company <=3 shows 1.7x higher goal completion\",\"factors_insights_multiplier\":1.7,\"factors_insights_percentage\":4.08,\"factors_insights_users_count\":6446,\"factors_goal_users_count\":263,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Country\",\"factors_attribute_value\":\"USA\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Country = USA shows 1.6x higher goal completion\",\"factors_insights_multiplier\":1.6,\"factors_insights_percentage\":3.84,\"factors_insights_users_count\":1119,\"factors_goal_users_count\":43,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null}]},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Industry\",\"factors_attribute_value\":\"Health Care Providers & Services\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Industry = Health Care Providers & Services shows 0.5x lower goal completion\",\"factors_insights_multiplier\":0.5,\"factors_insights_percentage\":1.06,\"factors_insights_users_count\":11037,\"factors_goal_users_count\":117,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Revenue \",\"factors_attribute_value\":\"<5mn\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Revenue = <5mn shows 1.8x higher goal completion\",\"factors_insights_multiplier\":1.8,\"factors_insights_percentage\":3.8,\"factors_insights_users_count\":13526,\"factors_goal_users_count\":514,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Revenue\",\"factors_attribute_value\":\"6-15mn\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Revenue = 6-15mn shows 2.4x higher goal completion\",\"factors_insights_multiplier\":2.4,\"factors_insights_percentage\":5,\"factors_insights_users_count\":8840,\"factors_goal_users_count\":442,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Company_Revenue\",\"factors_attribute_value\":\"50mn+\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Company_Revenue = 50mn+ shows 0.6x lower goal completion\",\"factors_insights_multiplier\":0.6,\"factors_insights_percentage\":1.3,\"factors_insights_users_count\":9923,\"factors_goal_users_count\":129,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Num_contacts_in_company\",\"factors_attribute_value\":\"6-10\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Num_contacts_in_company = 6-10 shows 2.1x higher goal completion\",\"factors_insights_multiplier\":2.1,\"factors_insights_percentage\":4.4,\"factors_insights_users_count\":7750,\"factors_goal_users_count\":341,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"Num_Sessions\",\"factors_attribute_value\":\"<=3\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"of which visitors with Num_Sessions <=3 shows 0.7x lower goal completion\",\"factors_insights_multiplier\":0.7,\"factors_insights_percentage\":1.4,\"factors_insights_users_count\":30857,\"factors_goal_users_count\":432,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"attribute\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com\",\"factors_insights_text\":\"of which visitors coming via www.acme.com shows 1.26x higher goal completion\",\"factors_insights_multiplier\":1.26,\"factors_insights_percentage\":2.67,\"factors_insights_users_count\":61657,\"factors_goal_users_count\":1647,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/pricing\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/pricing shows 2.2x higher goal completion\",\"factors_insights_multiplier\":2.2,\"factors_insights_percentage\":4.6,\"factors_insights_users_count\":13636,\"factors_goal_users_count\":636,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/customers\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/customers shows 5.4x higher goal completion\",\"factors_insights_multiplier\":5.4,\"factors_insights_percentage\":11.4,\"factors_insights_users_count\":2087,\"factors_goal_users_count\":239,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/integrations\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/integrations shows 6.57x higher goal completion\",\"factors_insights_multiplier\":6.57,\"factors_insights_percentage\":13.9,\"factors_insights_users_count\":667,\"factors_goal_users_count\":93,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/product\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/product shows 1.6x higher goal completion\",\"factors_higher_completion_text\": \"Higher Completions for www.acme.com/integrations +5 factors\",\"factors_lower_completion_text\": \"Lower Completions for page_spent_time <= 5sec\",\"factors_insights_multiplier\":1.6,\"factors_insights_percentage\":3.3,\"factors_insights_users_count\":17187,\"factors_goal_users_count\":583,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":[{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/pricing\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/pricing shows 3.4x higher goal completion\",\"factors_insights_multiplier\":3.4,\"factors_insights_percentage\":5.54,\"factors_insights_users_count\":2279,\"factors_goal_users_count\":124,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/company\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/company shows 1.3x higher goal completion\",\"factors_insights_multiplier\":1.3,\"factors_insights_percentage\":2.08,\"factors_insights_users_count\":2692,\"factors_goal_users_count\":56,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/integrations\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/integrations shows 8.7x higher goal completion\",\"factors_insights_multiplier\":8.7,\"factors_insights_percentage\":13.92,\"factors_insights_users_count\":337,\"factors_goal_users_count\":47,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/resources\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/resources shows 1.4x higher goal completion\",\"factors_insights_multiplier\":1.4,\"factors_insights_percentage\":2.24,\"factors_insights_users_count\":758,\"factors_goal_users_count\":17,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"page_spent_time\",\"factors_attribute_value\":\"<= 5sec\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"where page_spent_time <= 5sec shows 0.6x lower goal completion\",\"factors_insights_multiplier\":0.6,\"factors_insights_percentage\":0.96,\"factors_insights_users_count\":2395,\"factors_goal_users_count\":23,\"factors_multiplier_increase_flag\":false,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":[{\"factors_attribute_key\":\"page_load_time\",\"factors_attribute_value\":\">= 3sec\"}],\"factors_insights_key\":\"\",\"factors_insights_text\":\"where page_load_time >= 3sec shows 1.1x higher goal completion\",\"factors_insights_multiplier\":1.1,\"factors_insights_percentage\":1.76,\"factors_insights_users_count\":2670,\"factors_goal_users_count\":47,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null}]},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/solutions\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/solutions shows 1.4x higher goal completion\",\"factors_insights_multiplier\":1.4,\"factors_insights_percentage\":3,\"factors_insights_users_count\":28571,\"factors_goal_users_count\":848,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/documentation\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/documentation shows 7.1x higher goal completion\",\"factors_insights_multiplier\":7.1,\"factors_insights_percentage\":15,\"factors_insights_users_count\":438,\"factors_goal_users_count\":66,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/resources\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/resources shows 1.3x higher goal completion\",\"factors_insights_multiplier\":1.3,\"factors_insights_percentage\":2.7,\"factors_insights_users_count\":6748,\"factors_goal_users_count\":186,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null},{\"factors_insights_attribute\":null,\"factors_insights_key\":\"www.acme.com/compliance\",\"factors_insights_text\":\"of which visitors coming via www.acme.com/compliance shows 8.2x higher goal completion\",\"factors_insights_multiplier\":8.2,\"factors_insights_percentage\":17.3,\"factors_insights_users_count\":304,\"factors_goal_users_count\":53,\"factors_multiplier_increase_flag\":true,\"factors_insights_type\":\"journey\",\"factors_sub_insights\":null}],\"goal_user_count\":2651,\"total_users_count\":124940,\"overall_percentage_text\":\"2.12% of all users have completed this goal\",\"overall_percentage\":2.12,\"overall_multiplier\":1}"
	fac := Factors{}
	if err := json.Unmarshal([]byte(factorsOutput), &fac); err != nil {
		return
	}

	projectID := U.GetScopeByKeyAsUint64(c, mid.SCOPE_PROJECT_ID)
	if projectID == 0 {
		c.AbortWithStatus(http.StatusBadRequest)
		return
	}
	c.JSON(http.StatusOK, fac)
}
